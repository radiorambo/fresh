import{_ as s,c as a,o as e,ag as t}from"./chunks/framework.CffQSbY-.js";const c=JSON.parse('{"title":"Visual Layout Unification Plan","description":"","frontmatter":{},"headers":[],"relativePath":"design/visual-layout.md","filePath":"design/visual-layout.md","lastUpdated":1767757023000}'),l={name:"design/visual-layout.md"};function n(h,i,p,r,o,d){return e(),a("div",null,[...i[0]||(i[0]=[t(`<h1 id="visual-layout-unification-plan" tabindex="-1">Visual Layout Unification Plan <a class="header-anchor" href="#visual-layout-unification-plan" aria-label="Permalink to &quot;Visual Layout Unification Plan&quot;">​</a></h1><h2 id="problem-statement" tabindex="-1">Problem Statement <a class="header-anchor" href="#problem-statement" aria-label="Permalink to &quot;Problem Statement&quot;">​</a></h2><p>The codebase has inconsistent handling of visual column calculations across different flows:</p><ol><li><p><strong>Rendering/cursor detection</strong> uses <code>ViewLine.char_mappings</code> indexed by visual column</p><ul><li>Zero-width chars (ANSI escapes) have no entries, breaking cursor detection</li></ul></li><li><p><strong>Mouse clicks</strong> use <code>char_mappings[visual_col]</code> for O(1) lookup</p><ul><li>Works for visible chars, but same zero-width issue</li></ul></li><li><p><strong>MoveUp/MoveDown</strong> use <code>str_width()</code> and <code>byte_offset_at_visual_column()</code> on raw buffer</p><ul><li>Doesn&#39;t understand ANSI escape sequences (counts <code>[</code>, <code>2</code>, <code>m</code> as width 1 each!)</li><li>Doesn&#39;t handle tab expansion consistently with rendering</li></ul></li></ol><h2 id="solution-unified-visual-layout-module" tabindex="-1">Solution: Unified Visual Layout Module <a class="header-anchor" href="#solution-unified-visual-layout-module" aria-label="Permalink to &quot;Solution: Unified Visual Layout Module&quot;">​</a></h2><h3 id="core-data-model" tabindex="-1">Core Data Model <a class="header-anchor" href="#core-data-model" aria-label="Permalink to &quot;Core Data Model&quot;">​</a></h3><div class="language-rust vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Per-line mappings that support all operations</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">pub</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> LineMappings</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Per-CHARACTER (indexed by char position in text)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Length == text.chars().count()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    pub</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> char_source_bytes</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Vec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Option</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">usize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;&gt;,</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Per-VISUAL-COLUMN (indexed by visual column)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Length == visual width of line</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    pub</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> visual_to_char</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Vec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">usize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="shared-utilities" tabindex="-1">Shared Utilities <a class="header-anchor" href="#shared-utilities" aria-label="Permalink to &quot;Shared Utilities&quot;">​</a></h3><div class="language-rust vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// primitives/visual_layout.rs</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/// Calculate visual width handling ANSI escapes, tabs, zero-width chars</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">pub</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> fn</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> visual_width</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(s</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, start_col</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> usize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> usize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/// Convert byte offset to visual column (ANSI-aware, tab-aware)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">pub</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> fn</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> byte_to_visual_col</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(s</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, byte_offset</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> usize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> usize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/// Convert visual column to byte offset (ANSI-aware, tab-aware)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">pub</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> fn</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> visual_col_to_byte</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(s</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, visual_col</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> usize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> usize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/// Build complete per-char and per-visual-col mappings</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">pub</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> fn</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> build_line_mappings</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(text</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, source_bytes</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Option</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">usize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;]) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> LineMappings</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><h3 id="o-1-operations" tabindex="-1">O(1) Operations <a class="header-anchor" href="#o-1-operations" aria-label="Permalink to &quot;O(1) Operations&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Operation</th><th>How</th><th>Complexity</th></tr></thead><tbody><tr><td>Mouse click at visual col V</td><td><code>char_idx = visual_to_char[V]</code><br><code>byte = char_source_bytes[char_idx]</code></td><td>O(1)</td></tr><tr><td>Cursor render at char I</td><td><code>byte = char_source_bytes[I]</code></td><td>O(1)</td></tr><tr><td>MoveUp/Down</td><td>Use shared <code>byte_to_visual_col()</code> and <code>visual_col_to_byte()</code></td><td>O(n) per line</td></tr></tbody></table><p>Note: MoveUp/Down is O(n) but only processes one line at a time, and navigation is infrequent compared to rendering.</p><h2 id="implementation-steps" tabindex="-1">Implementation Steps <a class="header-anchor" href="#implementation-steps" aria-label="Permalink to &quot;Implementation Steps&quot;">​</a></h2><h3 id="_1-create-primitives-visual-layout-rs" tabindex="-1">1. Create <code>primitives/visual_layout.rs</code> <a class="header-anchor" href="#_1-create-primitives-visual-layout-rs" aria-label="Permalink to &quot;1. Create \`primitives/visual_layout.rs\`&quot;">​</a></h3><ul><li>Move/refactor ANSI-aware width calculation from display_width.rs</li><li>Add <code>build_line_mappings()</code> function</li><li>Add <code>byte_to_visual_col()</code> and <code>visual_col_to_byte()</code> with ANSI/tab support</li></ul><h3 id="_2-update-viewline-in-view-pipeline-rs" tabindex="-1">2. Update <code>ViewLine</code> in <code>view_pipeline.rs</code> <a class="header-anchor" href="#_2-update-viewline-in-view-pipeline-rs" aria-label="Permalink to &quot;2. Update \`ViewLine\` in \`view_pipeline.rs\`&quot;">​</a></h3><ul><li>Replace <code>char_mappings: Vec&lt;Option&lt;usize&gt;&gt;</code> (per visual col)</li><li>With <code>char_source_bytes: Vec&lt;Option&lt;usize&gt;&gt;</code> (per char)</li><li>Add <code>visual_to_char: Vec&lt;usize&gt;</code> (per visual col)</li><li>Keep <code>char_styles</code> but make it per-char instead of per-visual-col</li></ul><h3 id="_3-update-view-pipeline-rs-iterator" tabindex="-1">3. Update <code>view_pipeline.rs</code> iterator <a class="header-anchor" href="#_3-update-view-pipeline-rs-iterator" aria-label="Permalink to &quot;3. Update \`view_pipeline.rs\` iterator&quot;">​</a></h3><ul><li>Build new mappings structure during iteration</li><li>One entry in char_source_bytes per character (including zero-width)</li><li>One entry in visual_to_char per visual column</li></ul><h3 id="_4-update-split-rendering-rs" tabindex="-1">4. Update <code>split_rendering.rs</code> <a class="header-anchor" href="#_4-update-split-rendering-rs" aria-label="Permalink to &quot;4. Update \`split_rendering.rs\`&quot;">​</a></h3><ul><li>Cursor detection: use <code>char_source_bytes[char_index]</code> instead of <code>char_mappings[col_offset]</code></li><li>Track char_index separately from col_offset during iteration</li><li><code>push_span_with_map</code>: update to build per-char mappings</li></ul><h3 id="_5-update-input-rs-mouse-click-handling" tabindex="-1">5. Update <code>input.rs</code> mouse click handling <a class="header-anchor" href="#_5-update-input-rs-mouse-click-handling" aria-label="Permalink to &quot;5. Update \`input.rs\` mouse click handling&quot;">​</a></h3><ul><li><code>screen_to_buffer_position</code>: use <code>visual_to_char[col]</code> then <code>char_source_bytes[char_idx]</code></li><li>Update <code>ViewLineMapping</code> struct to use new format</li></ul><h3 id="_6-update-actions-rs-moveup-movedown" tabindex="-1">6. Update <code>actions.rs</code> MoveUp/MoveDown <a class="header-anchor" href="#_6-update-actions-rs-moveup-movedown" aria-label="Permalink to &quot;6. Update \`actions.rs\` MoveUp/MoveDown&quot;">​</a></h3><ul><li>Replace <code>str_width()</code> with ANSI-aware <code>byte_to_visual_col()</code></li><li>Replace <code>byte_offset_at_visual_column()</code> with ANSI-aware <code>visual_col_to_byte()</code></li></ul><h2 id="migration-notes" tabindex="-1">Migration Notes <a class="header-anchor" href="#migration-notes" aria-label="Permalink to &quot;Migration Notes&quot;">​</a></h2><ul><li>The existing <code>display_width.rs</code> functions can remain for simple cases</li><li>New visual_layout.rs handles the complex ANSI/tab cases</li><li>Tests will need updating to reflect new data structures</li></ul>`,27)])])}const u=s(l,[["render",n]]);export{c as __pageData,u as default};
