import{_ as s,c as a,o as t,ag as e}from"./chunks/framework.CffQSbY-.js";const k=JSON.parse('{"title":"Unicode Width and Multi-byte Character Support","description":"","frontmatter":{},"headers":[],"relativePath":"design/unicode-width.md","filePath":"design/unicode-width.md","lastUpdated":1767757023000}'),n={name:"design/unicode-width.md"};function l(r,i,h,o,d,c){return t(),a("div",null,[...i[0]||(i[0]=[e(`<h1 id="unicode-width-and-multi-byte-character-support" tabindex="-1">Unicode Width and Multi-byte Character Support <a class="header-anchor" href="#unicode-width-and-multi-byte-character-support" aria-label="Permalink to &quot;Unicode Width and Multi-byte Character Support&quot;">​</a></h1><p>This document lists all the places in the codebase where visual display width must be accounted for, particularly for:</p><ul><li>CJK (Chinese, Japanese, Korean) characters that occupy 2 terminal columns</li><li>Emoji that occupy 2 terminal columns</li><li>Zero-width characters (combining marks, zero-width space)</li><li>Multi-byte UTF-8 characters (which may not correspond to visual width)</li></ul><h2 id="core-utility-module" tabindex="-1">Core Utility Module <a class="header-anchor" href="#core-utility-module" aria-label="Permalink to &quot;Core Utility Module&quot;">​</a></h2><h3 id="src-primitives-display-width-rs" tabindex="-1"><code>src/primitives/display_width.rs</code> <a class="header-anchor" href="#src-primitives-display-width-rs" aria-label="Permalink to &quot;\`src/primitives/display_width.rs\`&quot;">​</a></h3><p>The central utility module for all visual width calculations. Uses the <code>unicode-width</code> crate.</p><p><strong>Key functions:</strong></p><ul><li><code>char_width(c: char) -&gt; usize</code> - Returns visual width of a character (0, 1, or 2)</li><li><code>str_width(s: &amp;str) -&gt; usize</code> - Returns total visual width of a string</li><li><code>DisplayWidth</code> trait - Extension trait for convenient <code>.display_width()</code> method</li></ul><p><strong>Usage:</strong> Import from <code>crate::primitives::display_width::{char_width, str_width}</code></p><h2 id="critical-rendering-code" tabindex="-1">Critical Rendering Code <a class="header-anchor" href="#critical-rendering-code" aria-label="Permalink to &quot;Critical Rendering Code&quot;">​</a></h2><h3 id="src-primitives-line-wrapping-rs" tabindex="-1"><code>src/primitives/line_wrapping.rs</code> <a class="header-anchor" href="#src-primitives-line-wrapping-rs" aria-label="Permalink to &quot;\`src/primitives/line_wrapping.rs\`&quot;">​</a></h3><p>Line wrapping must wrap based on visual width, not character count.</p><p><strong>Key locations:</strong></p><ul><li><code>wrap_line()</code> function (lines 111-127) - Tracks <code>segment_visual_width</code> using <code>char_width(c)</code></li><li>Uses visual width to determine when to break lines</li><li>Property tests verify visual width correctness</li></ul><h3 id="src-view-ui-split-rendering-rs" tabindex="-1"><code>src/view/ui/split_rendering.rs</code> <a class="header-anchor" href="#src-view-ui-split-rendering-rs" aria-label="Permalink to &quot;\`src/view/ui/split_rendering.rs\`&quot;">​</a></h3><p>The main buffer rendering code that positions characters and cursors on screen.</p><p><strong>Key locations:</strong></p><ul><li>Line ~2150: <code>visible_char_count += char_width(ch)</code> - Tracks visual column during character iteration</li><li>Line ~2927: <code>str_width(&amp;span.content)</code> - Counts span width for cursor position detection (in test code)</li></ul><p><strong>Important:</strong> The <code>visible_char_count</code> variable tracks visual columns, not character indices.</p><h3 id="src-view-viewport-rs" tabindex="-1"><code>src/view/viewport.rs</code> <a class="header-anchor" href="#src-view-viewport-rs" aria-label="Permalink to &quot;\`src/view/viewport.rs\`&quot;">​</a></h3><p>Viewport scrolling calculations for horizontal scroll.</p><p><strong>Key locations:</strong></p><ul><li>Lines ~381-394: Calculates cursor visual column by walking through characters and summing widths</li><li>Line ~394: <code>str_width(line_text)</code> for line visual width</li><li><code>ensure_column_visible_simple()</code> uses visual widths for scroll calculations</li></ul><h3 id="src-primitives-ansi-rs" tabindex="-1"><code>src/primitives/ansi.rs</code> <a class="header-anchor" href="#src-primitives-ansi-rs" aria-label="Permalink to &quot;\`src/primitives/ansi.rs\`&quot;">​</a></h3><p>ANSI escape code handling must exclude invisible escape sequences from width.</p><p><strong>Key locations:</strong></p><ul><li><code>visible_char_count()</code> function (lines ~302-319) - Returns visual width excluding ANSI codes</li><li>Uses <code>str_width()</code> for fast path (no ANSI) and <code>char_width()</code> for character-by-character parsing</li></ul><h2 id="ui-components" tabindex="-1">UI Components <a class="header-anchor" href="#ui-components" aria-label="Permalink to &quot;UI Components&quot;">​</a></h2><h3 id="src-view-ui-status-bar-rs" tabindex="-1"><code>src/view/ui/status_bar.rs</code> <a class="header-anchor" href="#src-view-ui-status-bar-rs" aria-label="Permalink to &quot;\`src/view/ui/status_bar.rs\`&quot;">​</a></h3><p>Status bar text truncation must account for visual width.</p><p><strong>Key locations:</strong></p><ul><li>Lines ~504-529: Truncates left status by visual width using <code>str_width()</code> and <code>char_width()</code></li><li>Lines ~538: Calculates padding using <code>str_width(&amp;displayed_left)</code></li><li>Lines ~602-639: Similar truncation logic for narrow terminal case</li></ul><p><strong>Truncation pattern:</strong></p><div class="language-rust vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> visual_width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> str_width</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">text);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> visual_width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> max_width {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> mut</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> truncated</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> String</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> text</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chars</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">take_while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ch</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> w </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> char_width</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ch);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> w </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> truncate_at {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> w;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                true</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                false</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        })</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">collect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    format!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;{}...&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, truncated)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="src-view-ui-tabs-rs" tabindex="-1"><code>src/view/ui/tabs.rs</code> <a class="header-anchor" href="#src-view-ui-tabs-rs" aria-label="Permalink to &quot;\`src/view/ui/tabs.rs\`&quot;">​</a></h3><p>Tab bar width calculations.</p><p><strong>Key locations:</strong></p><ul><li>Lines ~200-205: <code>str_width(&amp;tab_name_text)</code> and <code>str_width(close_text)</code> for tab sizing</li></ul><h3 id="src-view-ui-file-explorer-rs" tabindex="-1"><code>src/view/ui/file_explorer.rs</code> <a class="header-anchor" href="#src-view-ui-file-explorer-rs" aria-label="Permalink to &quot;\`src/view/ui/file_explorer.rs\`&quot;">​</a></h3><p>File explorer tree view layout.</p><p><strong>Key locations:</strong></p><ul><li>Line ~176: <code>str_width(&amp;node.entry.name)</code> for name column width</li><li>Line ~249: <code>str_width(&amp;size_text)</code> for file size alignment</li></ul><h3 id="src-view-ui-file-browser-rs" tabindex="-1"><code>src/view/ui/file_browser.rs</code> <a class="header-anchor" href="#src-view-ui-file-browser-rs" aria-label="Permalink to &quot;\`src/view/ui/file_browser.rs\`&quot;">​</a></h3><p>File browser popup for Open File dialog.</p><p><strong>Key locations:</strong></p><ul><li>Line ~567: <code>str_width(label) + 2</code> for shortcut label width in navigation bar</li></ul><h3 id="src-view-ui-suggestions-rs" tabindex="-1"><code>src/view/ui/suggestions.rs</code> <a class="header-anchor" href="#src-view-ui-suggestions-rs" aria-label="Permalink to &quot;\`src/view/ui/suggestions.rs\`&quot;">​</a></h3><p>Autocomplete/command palette suggestion rendering.</p><p><strong>Key locations (all use visual-width-aware truncation):</strong></p><ul><li>Lines ~139-162: Command name column</li><li>Lines ~188-213: Keybinding column</li><li>Lines ~235-271: Description column</li><li>Lines ~310-331: Source column</li></ul><p>Each column uses the truncation pattern shown above.</p><h2 id="locations-that-don-t-need-visual-width" tabindex="-1">Locations That DON&#39;T Need Visual Width <a class="header-anchor" href="#locations-that-don-t-need-visual-width" aria-label="Permalink to &quot;Locations That DON&#39;T Need Visual Width&quot;">​</a></h2><p>Some <code>.chars().count()</code> usages are intentionally character-based:</p><h3 id="character-indexing-into-data-structures" tabindex="-1">Character Indexing into Data Structures <a class="header-anchor" href="#character-indexing-into-data-structures" aria-label="Permalink to &quot;Character Indexing into Data Structures&quot;">​</a></h3><ul><li><code>char_mappings</code> vectors in <code>split_rendering.rs</code> (lines ~1003, ~2162, ~2271) <ul><li>These index into character-indexed data structures, not visual positions</li><li>The vectors have one element per character, not per visual column</li></ul></li></ul><h3 id="test-assertions" tabindex="-1">Test Assertions <a class="header-anchor" href="#test-assertions" aria-label="Permalink to &quot;Test Assertions&quot;">​</a></h3><ul><li>Test code that verifies character count vs byte count (e.g., <code>fancy_quote.chars().count() == 1</code>)</li></ul><h2 id="common-pitfalls" tabindex="-1">Common Pitfalls <a class="header-anchor" href="#common-pitfalls" aria-label="Permalink to &quot;Common Pitfalls&quot;">​</a></h2><ol><li><p><strong>Byte length vs character count vs visual width:</strong></p><ul><li><code>s.len()</code> - byte count (wrong for multi-byte UTF-8)</li><li><code>s.chars().count()</code> - character count (wrong for double-width)</li><li><code>str_width(s)</code> - visual width (correct for display)</li></ul></li><li><p><strong>Truncation must use visual width:</strong></p><div class="language-rust vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// WRONG: truncates by character count</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">text</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chars</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">take</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(max_width)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">collect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// RIGHT: truncates by visual width</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> mut</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">text</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chars</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">take_while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ch</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> w </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> char_width</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ch);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> w </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> max_width { width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> w; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">collect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div></li><li><p><strong>Cursor positioning:</strong></p><ul><li>Screen X coordinate = sum of visual widths of characters before cursor</li><li>NOT the character index</li></ul></li><li><p><strong>Line wrapping:</strong></p><ul><li>Wrap when visual width exceeds terminal width</li><li>NOT when character count exceeds</li></ul></li></ol><h2 id="testing" tabindex="-1">Testing <a class="header-anchor" href="#testing" aria-label="Permalink to &quot;Testing&quot;">​</a></h2><h3 id="unit-tests" tabindex="-1">Unit Tests <a class="header-anchor" href="#unit-tests" aria-label="Permalink to &quot;Unit Tests&quot;">​</a></h3><ul><li><code>src/primitives/display_width.rs</code> - Tests for width functions</li><li><code>src/primitives/line_wrapping.rs</code> - Tests including: <ul><li><code>test_visual_width_calculation</code></li><li><code>test_wrap_line_double_width_characters</code></li><li><code>test_wrap_line_emoji_visual_width</code></li><li><code>test_wrap_line_mixed_ascii_and_cjk</code></li><li><code>test_chars_count_vs_visual_width_bug</code> (regression test)</li></ul></li></ul><h3 id="property-tests" tabindex="-1">Property Tests <a class="header-anchor" href="#property-tests" aria-label="Permalink to &quot;Property Tests&quot;">​</a></h3><ul><li><code>src/primitives/line_wrapping.rs::proptests</code> module</li><li>Tests wrap_line with various Unicode character combinations</li></ul><h3 id="e2e-tests" tabindex="-1">E2E Tests <a class="header-anchor" href="#e2e-tests" aria-label="Permalink to &quot;E2E Tests&quot;">​</a></h3><ul><li><code>tests/e2e/multibyte_characters.rs</code> - End-to-end tests for multi-byte character handling</li></ul><h2 id="dependencies" tabindex="-1">Dependencies <a class="header-anchor" href="#dependencies" aria-label="Permalink to &quot;Dependencies&quot;">​</a></h2><ul><li><code>unicode-width = &quot;0.2&quot;</code> in <code>Cargo.toml</code></li><li>Uses UAX#11 (Unicode Standard Annex #11) East Asian Width property</li></ul>`,68)])])}const u=s(n,[["render",l]]);export{k as __pageData,u as default};
