import{_ as i,c as a,o as e,ag as n}from"./chunks/framework.CffQSbY-.js";const c=JSON.parse('{"title":"TimeSource Abstraction (Implemented)","description":"","frontmatter":{},"headers":[],"relativePath":"internal/TIMESOURCE_DESIGN.md","filePath":"internal/TIMESOURCE_DESIGN.md","lastUpdated":1766060490000}'),t={name:"internal/TIMESOURCE_DESIGN.md"};function l(h,s,r,p,o,d){return e(),a("div",null,[...s[0]||(s[0]=[n(`<h1 id="timesource-abstraction-implemented" tabindex="-1">TimeSource Abstraction (Implemented) <a class="header-anchor" href="#timesource-abstraction-implemented" aria-label="Permalink to &quot;TimeSource Abstraction (Implemented)&quot;">​</a></h1><p>This document started as a design proposal. The <code>TimeSource</code> abstraction is now implemented in <code>src/services/time_source.rs</code> and is wired through <code>Editor</code> for deterministic tests.</p><p>If you are looking for “what exists today”, prefer this document over older references.</p><h2 id="problem-statement" tabindex="-1">Problem Statement <a class="header-anchor" href="#problem-statement" aria-label="Permalink to &quot;Problem Statement&quot;">​</a></h2><p>The codebase currently has direct calls to <code>std::thread::sleep()</code> and <code>std::time::Instant::now()</code> scattered throughout production and test code. This creates several issues:</p><ol><li><strong>Slow tests</strong>: Tests that need to wait for time-based events (e.g., debouncing, periodic checks) must use real <code>thread::sleep</code>, making the test suite unnecessarily slow.</li><li><strong>Flaky tests</strong>: Time-dependent tests can be flaky due to system load variations.</li><li><strong>Poor testability</strong>: Code with hard-coded time dependencies is difficult to test in isolation.</li></ol><h2 id="current-usage-today" tabindex="-1">Current Usage (Today) <a class="header-anchor" href="#current-usage-today" aria-label="Permalink to &quot;Current Usage (Today)&quot;">​</a></h2><p>As of the current code:</p><ul><li>Most editor subsystems that need time use <code>Editor</code>’s <code>time_source</code> (<code>SharedTimeSource</code>), so tests can run deterministically by swapping in <code>TestTimeSource</code>.</li><li>The <code>main.rs</code> frame loop still uses real time (<code>std::time::Instant</code>) because terminal event polling (<code>crossterm::event::poll</code>) is inherently wall-clock driven.</li><li>There are still a few direct <code>std::thread::sleep</code> usages in non-interactive/background paths (e.g., release checker loops) and in tests; use <code>rg &quot;thread::sleep&quot;</code> and <code>rg &quot;Instant::now&quot;</code> to get an up-to-date list.</li></ul><p>System time (<code>SystemTime</code>) is still used where wall-clock timestamps are required (e.g., file mtimes).</p><h2 id="proposed-solution" tabindex="-1">Proposed Solution <a class="header-anchor" href="#proposed-solution" aria-label="Permalink to &quot;Proposed Solution&quot;">​</a></h2><h3 id="timesource-trait" tabindex="-1">TimeSource Trait <a class="header-anchor" href="#timesource-trait" aria-label="Permalink to &quot;TimeSource Trait&quot;">​</a></h3><p>The <code>TimeSource</code> trait abstracts time-related operations:</p><div class="language-rust vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// src/services/time_source.rs</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">use</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> std</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sync</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Arc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">use</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> std</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">time</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Duration</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Instant</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/// Abstraction over time-related operations.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">///</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/// This trait allows production code to use real system time while tests</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/// can use a controllable mock implementation for fast, deterministic testing.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">pub</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> trait</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TimeSource</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Send</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Sync</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /// Get the current instant for measuring elapsed time.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    fn</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Instant</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /// Sleep for the specified duration.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    ///</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /// In tests, this may be a no-op or advance logical time.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    fn</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sleep</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, duration</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Duration</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /// Get the current instant, usable for elapsed time comparisons.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /// Returns an opaque value that can be compared with other instants</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /// from the same TimeSource.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    fn</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> elapsed_since</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, earlier</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Instant</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Duration</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        self</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">saturating_duration_since</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(earlier)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/// Type alias for shared time source</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">pub</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SharedTimeSource</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Arc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">dyn</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TimeSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span></code></pre></div><h3 id="realtimesource-implementation" tabindex="-1">RealTimeSource Implementation <a class="header-anchor" href="#realtimesource-implementation" aria-label="Permalink to &quot;RealTimeSource Implementation&quot;">​</a></h3><p>Implemented as <code>RealTimeSource</code> in <code>src/services/time_source.rs</code>.</p><h3 id="testtimesource-implementation" tabindex="-1">TestTimeSource Implementation <a class="header-anchor" href="#testtimesource-implementation" aria-label="Permalink to &quot;TestTimeSource Implementation&quot;">​</a></h3><p>Implemented as <code>TestTimeSource</code> in <code>src/services/time_source.rs</code>.</p><p>Note: <code>TestTimeSource::sleep()</code> advances logical time (it is not a no-op), which keeps tests fast while still letting production code “sleep” against a controllable clock.</p><h2 id="integration-architecture" tabindex="-1">Integration Architecture <a class="header-anchor" href="#integration-architecture" aria-label="Permalink to &quot;Integration Architecture&quot;">​</a></h2><h3 id="flow-through-application-layers" tabindex="-1">Flow Through Application Layers <a class="header-anchor" href="#flow-through-application-layers" aria-label="Permalink to &quot;Flow Through Application Layers&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>main()</span></span>
<span class="line"><span>  │</span></span>
<span class="line"><span>  ├──► Creates RealTimeSource (or TestTimeSource in tests)</span></span>
<span class="line"><span>  │</span></span>
<span class="line"><span>  ├──► Editor::with_working_dir(..., time_source?)</span></span>
<span class="line"><span>  │      │</span></span>
<span class="line"><span>  │      ├──► LspManager::new(..., time_source.clone())</span></span>
<span class="line"><span>  │      │</span></span>
<span class="line"><span>  │      ├──► RecoveryService::new(..., time_source.clone())</span></span>
<span class="line"><span>  │      │</span></span>
<span class="line"><span>  │      └──► Other services that need time...</span></span>
<span class="line"><span>  │</span></span>
<span class="line"><span>  └──► run_event_loop(...)</span></span>
<span class="line"><span>         │</span></span>
<span class="line"><span>         └──► Uses std::time::Instant for frame timing</span></span></code></pre></div><h3 id="changes-required" tabindex="-1">Changes Required <a class="header-anchor" href="#changes-required" aria-label="Permalink to &quot;Changes Required&quot;">​</a></h3><p>This section is largely complete.</p><p>Current status:</p><ul><li>Implemented: <code>src/services/time_source.rs</code> and <code>src/services/mod.rs</code></li><li>Implemented: <code>Editor</code> owns a <code>SharedTimeSource</code> (defaulting to <code>RealTimeSource::shared()</code> when not provided); see <code>src/app/mod.rs</code></li><li>Implemented: most editor subsystems use <code>self.time_source</code> for timing (mouse hover delays, double-click detection, auto-save timers, file polling debouncing, etc.)</li><li>Not implemented (by design): the <code>main.rs</code> frame loop uses real time (<code>std::time::Instant</code> and <code>crossterm::event::poll</code>), because terminal polling is inherently wall-clock driven</li></ul><h2 id="migration-strategy" tabindex="-1">Migration Strategy <a class="header-anchor" href="#migration-strategy" aria-label="Permalink to &quot;Migration Strategy&quot;">​</a></h2><p>Most migration steps are complete. Remaining work is to keep new time-based features using <code>TimeSource</code> rather than introducing ad-hoc <code>Instant::now()</code> usage in test-sensitive code.</p><h2 id="special-cases" tabindex="-1">Special Cases <a class="header-anchor" href="#special-cases" aria-label="Permalink to &quot;Special Cases&quot;">​</a></h2><h3 id="signal-handler" tabindex="-1">Signal Handler <a class="header-anchor" href="#signal-handler" aria-label="Permalink to &quot;Signal Handler&quot;">​</a></h3><p>The sleep in <code>signal_handler.rs</code> (line 114) should remain as real <code>thread::sleep</code> because:</p><ul><li>It runs in a signal handler context</li><li>It needs real wall-clock time for thread backtrace capture</li><li>Tests don&#39;t typically exercise signal handlers</li></ul><h3 id="frame-timing" tabindex="-1">Frame Timing <a class="header-anchor" href="#frame-timing" aria-label="Permalink to &quot;Frame Timing&quot;">​</a></h3><p>The frame timing in <code>main.rs</code> currently uses <code>std::time::Instant</code>. This is acceptable because:</p><ul><li>The poll timeout is for responsiveness, not correctness</li><li>Tests use the script control mode which doesn&#39;t use the event loop</li></ul><h2 id="benefits" tabindex="-1">Benefits <a class="header-anchor" href="#benefits" aria-label="Permalink to &quot;Benefits&quot;">​</a></h2><ol><li><strong>Fast tests</strong>: No more waiting for real sleeps in tests</li><li><strong>Deterministic</strong>: Tests run identically regardless of system load</li><li><strong>Better coverage</strong>: Can test time-dependent edge cases easily</li><li><strong>Clean architecture</strong>: Clear separation between time source and business logic</li></ol><h2 id="api-examples" tabindex="-1">API Examples <a class="header-anchor" href="#api-examples" aria-label="Permalink to &quot;API Examples&quot;">​</a></h2><h3 id="production-usage" tabindex="-1">Production Usage <a class="header-anchor" href="#production-usage" aria-label="Permalink to &quot;Production Usage&quot;">​</a></h3><div class="language-rust vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">use</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fresh</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">services</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">time_source</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">RealTimeSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> time_source </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> RealTimeSource</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">shared</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Editor construction defaults to RealTimeSource when not supplied explicitly.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// When you want to override (tests, embedding), pass \`time_source\` through the Editor constructor.</span></span></code></pre></div><h3 id="test-usage" tabindex="-1">Test Usage <a class="header-anchor" href="#test-usage" aria-label="Permalink to &quot;Test Usage&quot;">​</a></h3><div class="language-rust vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">use</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fresh</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">services</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">time_source</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">TestTimeSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">use</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> std</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">time</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Duration</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> time_source </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TestTimeSource</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">shared</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Advance time by 5 seconds (instant, no actual waiting)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">time_source</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">advance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Duration</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">from_secs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Check that time-based behavior occurred</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">assert!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(harness</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">auto_save_triggered</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span></code></pre></div>`,42)])])}const g=i(t,[["render",l]]);export{c as __pageData,g as default};
