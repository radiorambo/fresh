import{_ as i,c as a,o as e,ag as n}from"./chunks/framework.CffQSbY-.js";const c=JSON.parse('{"title":"Built-in Terminal for Fresh","description":"","frontmatter":{},"headers":[],"relativePath":"features/terminal.md","filePath":"features/terminal.md","lastUpdated":1767757023000}'),l={name:"features/terminal.md"};function t(r,s,h,p,o,d){return e(),a("div",null,[...s[0]||(s[0]=[n(`<h1 id="built-in-terminal-for-fresh" tabindex="-1">Built-in Terminal for Fresh <a class="header-anchor" href="#built-in-terminal-for-fresh" aria-label="Permalink to &quot;Built-in Terminal for Fresh&quot;">​</a></h1><h2 id="architecture-overview" tabindex="-1">Architecture Overview <a class="header-anchor" href="#architecture-overview" aria-label="Permalink to &quot;Architecture Overview&quot;">​</a></h2><p>Fresh&#39;s terminal is implemented as a special buffer type backed by <code>alacritty_terminal</code> for VT100/ANSI emulation and <code>portable-pty</code> for cross-platform PTY management. Terminals can be displayed in any split and support two modes:</p><ul><li><strong>Terminal mode</strong>: Live interactive shell, input goes to PTY</li><li><strong>Scrollback mode</strong>: Read-only buffer view with editor navigation/selection</li></ul><hr><h2 id="incremental-scrollback-streaming" tabindex="-1">Incremental Scrollback Streaming <a class="header-anchor" href="#incremental-scrollback-streaming" aria-label="Permalink to &quot;Incremental Scrollback Streaming&quot;">​</a></h2><p>The terminal uses an <strong>incremental streaming architecture</strong> that avoids O(n) work on mode switches and session restore. The key insight is that scrollback history is append-only.</p><h3 id="file-structure" tabindex="-1">File Structure <a class="header-anchor" href="#file-structure" aria-label="Permalink to &quot;File Structure&quot;">​</a></h3><p>Each terminal maintains a single <strong>backing file</strong> containing rendered text:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>~/.local/share/fresh/terminals/{encoded_workdir}/fresh-terminal-{id}.txt</span></span></code></pre></div><p>The backing file structure:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>┌─────────────────────────────────────────┐</span></span>
<span class="line"><span>│ Scrollback history (append-only)        │  ← grows incrementally as lines</span></span>
<span class="line"><span>│ Line 1                                  │    scroll off the top of screen</span></span>
<span class="line"><span>│ Line 2                                  │</span></span>
<span class="line"><span>│ ...                                     │</span></span>
<span class="line"><span>│ Line N                                  │</span></span>
<span class="line"><span>├─────────────────────────────────────────┤</span></span>
<span class="line"><span>│ Visible screen (rewritable tail)        │  ← present only in scrollback mode</span></span>
<span class="line"><span>│ Screen line 0                           │    (~50 lines, rewritten each switch)</span></span>
<span class="line"><span>│ ...                                     │</span></span>
<span class="line"><span>│ Screen line 49                          │</span></span>
<span class="line"><span>└─────────────────────────────────────────┘</span></span></code></pre></div><h3 id="data-flow" tabindex="-1">Data Flow <a class="header-anchor" href="#data-flow" aria-label="Permalink to &quot;Data Flow&quot;">​</a></h3><p><strong>During terminal operation (PTY read loop):</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>PTY output bytes</span></span>
<span class="line"><span>    │</span></span>
<span class="line"><span>    ▼</span></span>
<span class="line"><span>state.process_output()  ──►  TerminalState (in-memory grid)</span></span>
<span class="line"><span>    │</span></span>
<span class="line"><span>    ▼</span></span>
<span class="line"><span>check: history_size increased?</span></span>
<span class="line"><span>    │</span></span>
<span class="line"><span>   YES ──►  append new scrollback lines to backing file</span></span>
<span class="line"><span>            (one line at a time, as they scroll off screen)</span></span></code></pre></div><p><strong>Exit terminal mode (enter scrollback mode):</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>1. Append visible screen (~50 lines) to backing file</span></span>
<span class="line"><span>2. Load backing file as read-only buffer (lazy load, instant)</span></span></code></pre></div><p><strong>Re-enter terminal mode:</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>1. Truncate backing file to scrollback-only (remove visible screen tail)</span></span>
<span class="line"><span>2. Resume live terminal rendering from TerminalState</span></span></code></pre></div><p><strong>Quit while in terminal mode:</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>1. Append visible screen to backing file (ensure complete state)</span></span>
<span class="line"><span>2. Save session as normal</span></span></code></pre></div><p><strong>Session restore:</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>1. Load backing file directly (lazy load, instant)</span></span>
<span class="line"><span>2. User starts in scrollback mode viewing last session state</span></span>
<span class="line"><span>3. Raw log replay only if user re-enters terminal mode (deferred)</span></span></code></pre></div><h3 id="performance-characteristics" tabindex="-1">Performance Characteristics <a class="header-anchor" href="#performance-characteristics" aria-label="Permalink to &quot;Performance Characteristics&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Operation</th><th>Before</th><th>After</th></tr></thead><tbody><tr><td>Mode switch</td><td>~500ms (replay + full_content_string)</td><td>~5ms (append 50 lines)</td></tr><tr><td>Session restore</td><td>~1000ms (replay 2x)</td><td>~10ms (lazy load)</td></tr><tr><td>PTY read overhead</td><td>~0</td><td>~0.1ms per scroll (append one line)</td></tr></tbody></table><h3 id="state-tracking" tabindex="-1">State Tracking <a class="header-anchor" href="#state-tracking" aria-label="Permalink to &quot;State Tracking&quot;">​</a></h3><div class="language-rust vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">pub</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TerminalState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    term</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Term</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">NullListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    parser</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Processor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    cols</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> u16</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    rows</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> u16</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    dirty</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    terminal_title</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Incremental streaming state</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    synced_history_lines</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> usize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,      </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// lines already written to backing file</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    backing_file_history_end</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> u64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,    </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// byte offset where scrollback ends</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="key-methods" tabindex="-1">Key Methods <a class="header-anchor" href="#key-methods" aria-label="Permalink to &quot;Key Methods&quot;">​</a></h3><div class="language-rust vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">impl</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TerminalState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /// Append any new scrollback lines to the backing file.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /// Called after process_output() in the PTY read loop.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    pub</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> fn</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> flush_new_scrollback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">W</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Write</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;mut</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, writer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;mut</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> W</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> io</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Result</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">usize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /// Append visible screen content to the backing file.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /// Called when exiting terminal mode.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    pub</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> fn</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> append_visible_screen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">W</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Write</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, writer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;mut</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> W</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> io</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Result</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;()&gt;;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /// Get byte offset where scrollback ends (for truncation on mode re-entry).</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    pub</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> fn</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> backing_file_history_end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> u64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="terminal-resize-handling" tabindex="-1">Terminal Resize Handling <a class="header-anchor" href="#terminal-resize-handling" aria-label="Permalink to &quot;Terminal Resize Handling&quot;">​</a></h3><p>When terminal is resized:</p><ul><li>Old scrollback lines remain as-is (rendered at old width)</li><li>New scrollback lines are rendered at new width</li><li>The editor&#39;s line wrapping handles display of mixed-width lines</li><li>No O(n) rewrite of history required</li></ul><p>This is a feature: original output is preserved at original width rather than being re-wrapped or truncated.</p><hr><h2 id="raw-log-file-optional" tabindex="-1">Raw Log File (Optional) <a class="header-anchor" href="#raw-log-file-optional" aria-label="Permalink to &quot;Raw Log File (Optional)&quot;">​</a></h2><p>For re-entering terminal mode after session restore, a raw log of PTY bytes is maintained:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>~/.local/share/fresh/terminals/{encoded_workdir}/fresh-terminal-{id}.log</span></span></code></pre></div><p>This file:</p><ul><li>Contains raw VTE escape sequences exactly as received from PTY</li><li>Enables rebuilding full <code>TerminalState</code> via replay</li><li>Only needed if user wants to resume live terminal after restore</li><li>Can be disabled if terminals always start fresh on session restore</li></ul><hr><h2 id="mode-switching" tabindex="-1">Mode Switching <a class="header-anchor" href="#mode-switching" aria-label="Permalink to &quot;Mode Switching&quot;">​</a></h2><h3 id="terminal-mode-→-scrollback-mode-ctrl-space" tabindex="-1">Terminal Mode → Scrollback Mode (Ctrl+Space) <a class="header-anchor" href="#terminal-mode-→-scrollback-mode-ctrl-space" aria-label="Permalink to &quot;Terminal Mode → Scrollback Mode (Ctrl+Space)&quot;">​</a></h3><ol><li>Append visible screen to backing file</li><li>Update <code>backing_file_history_end</code> to current file position minus screen size</li><li>Load backing file as read-only buffer (lazy load)</li><li>Set <code>editing_disabled = true</code></li><li>User can navigate, select, copy, search</li></ol><h3 id="scrollback-mode-→-terminal-mode-ctrl-space" tabindex="-1">Scrollback Mode → Terminal Mode (Ctrl+Space) <a class="header-anchor" href="#scrollback-mode-→-terminal-mode-ctrl-space" aria-label="Permalink to &quot;Scrollback Mode → Terminal Mode (Ctrl+Space)&quot;">​</a></h3><ol><li>Truncate backing file to <code>backing_file_history_end</code></li><li>Set <code>editing_disabled = false</code></li><li>Resume live rendering from <code>TerminalState</code></li><li>Scroll view to cursor position (bottom of terminal)</li></ol><hr><h2 id="session-persistence" tabindex="-1">Session Persistence <a class="header-anchor" href="#session-persistence" aria-label="Permalink to &quot;Session Persistence&quot;">​</a></h2><h3 id="session-save" tabindex="-1">Session Save <a class="header-anchor" href="#session-save" aria-label="Permalink to &quot;Session Save&quot;">​</a></h3><div class="language-rust vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TerminalSession</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    pub</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> u64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    pub</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> shell</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    pub</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cwd</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PathBuf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    pub</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cols</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> u16</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    pub</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rows</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> u16</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    pub</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> backing_path</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PathBuf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    pub</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> log_path</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PathBuf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// for optional live terminal resume</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>Before saving session:</p><ul><li>If in terminal mode, append visible screen to backing file</li><li>This ensures backing file always contains complete state</li></ul><h3 id="session-restore" tabindex="-1">Session Restore <a class="header-anchor" href="#session-restore" aria-label="Permalink to &quot;Session Restore&quot;">​</a></h3><ol><li>Load backing file directly as read-only buffer</li><li>User sees last session state immediately (lazy load)</li><li>If user presses Ctrl+Space to enter terminal mode: <ul><li>Spawn new PTY with same shell/cwd</li><li>Optionally replay raw log to restore <code>TerminalState</code></li><li>Or start fresh (simpler, recommended default)</li></ul></li></ol><hr><h2 id="integration-with-existing-buffer-system" tabindex="-1">Integration with Existing Buffer System <a class="header-anchor" href="#integration-with-existing-buffer-system" aria-label="Permalink to &quot;Integration with Existing Buffer System&quot;">​</a></h2><p>The backing file integrates with Fresh&#39;s existing file-backed buffer architecture:</p><ul><li>Files &gt; 1MB use lazy loading (<code>BufferData::Unloaded</code>)</li><li>Chunks loaded on-demand as user scrolls</li><li>Full 200K line scrollback (~15MB) loads instantly</li><li>Search, selection, copy all work via normal buffer mechanisms</li></ul><p>This is why the incremental streaming approach works: we&#39;re not building a new system, we&#39;re leveraging the existing efficient buffer infrastructure.</p><hr><h2 id="implementation-checklist" tabindex="-1">Implementation Checklist <a class="header-anchor" href="#implementation-checklist" aria-label="Permalink to &quot;Implementation Checklist&quot;">​</a></h2><h3 id="core-changes" tabindex="-1">Core Changes <a class="header-anchor" href="#core-changes" aria-label="Permalink to &quot;Core Changes&quot;">​</a></h3><ul><li>[ ] Add <code>synced_history_lines</code> and <code>backing_file_history_end</code> to <code>TerminalState</code></li><li>[ ] Implement <code>flush_new_scrollback()</code> method</li><li>[ ] Implement <code>append_visible_screen()</code> method</li><li>[ ] Update PTY read loop to call <code>flush_new_scrollback()</code> after <code>process_output()</code></li><li>[ ] Pass backing file writer to PTY read thread</li></ul><h3 id="mode-switch-changes" tabindex="-1">Mode Switch Changes <a class="header-anchor" href="#mode-switch-changes" aria-label="Permalink to &quot;Mode Switch Changes&quot;">​</a></h3><ul><li>[ ] <code>sync_terminal_to_buffer()</code>: append screen + lazy load (no replay)</li><li>[ ] <code>enter_terminal_mode()</code>: truncate backing file</li><li>[ ] On quit: ensure visible screen is appended before session save</li></ul><h3 id="session-restore-changes" tabindex="-1">Session Restore Changes <a class="header-anchor" href="#session-restore-changes" aria-label="Permalink to &quot;Session Restore Changes&quot;">​</a></h3><ul><li>[ ] Load backing file directly (skip log replay)</li><li>[ ] Defer log replay to <code>enter_terminal_mode()</code> if needed</li><li>[ ] Consider removing log replay entirely (fresh terminal on restore)</li></ul><h3 id="cleanup" tabindex="-1">Cleanup <a class="header-anchor" href="#cleanup" aria-label="Permalink to &quot;Cleanup&quot;">​</a></h3><ul><li>[ ] Remove <code>full_content_string()</code> method (no longer needed)</li><li>[ ] Remove <code>replay_terminal_log_into_state()</code> from restore path</li><li>[ ] Update tests for new architecture</li></ul><hr><h2 id="known-issues" tabindex="-1">Known Issues <a class="header-anchor" href="#known-issues" aria-label="Permalink to &quot;Known Issues&quot;">​</a></h2><h3 id="critical" tabindex="-1">Critical <a class="header-anchor" href="#critical" aria-label="Permalink to &quot;Critical&quot;">​</a></h3><ol><li><p><strong>Read-only mode accepts input</strong>: Text is inserted into buffer in scrollback mode. Fix: ensure <code>editing_disabled</code> is respected.</p></li><li><p><strong>Keybindings don&#39;t work in scrollback mode</strong>: All keys typed as text. Fix: ensure <code>KeyContext::Normal</code> is set on mode exit.</p></li></ol><h3 id="high-priority" tabindex="-1">High Priority <a class="header-anchor" href="#high-priority" aria-label="Permalink to &quot;High Priority&quot;">​</a></h3><ol start="3"><li><strong>View doesn&#39;t scroll to cursor on resume</strong>: After scrolling in scrollback mode, resuming terminal mode leaves view at wrong position. Fix: scroll to bottom on mode entry.</li></ol><h3 id="medium-priority" tabindex="-1">Medium Priority <a class="header-anchor" href="#medium-priority" aria-label="Permalink to &quot;Medium Priority&quot;">​</a></h3><ol start="4"><li><p><strong>Inconsistent display between modes</strong>: Line numbers and layout differ. Consider unifying visual presentation.</p></li><li><p><strong>Status message truncated on narrow terminals</strong>: &quot;Terminal mode disabled...&quot; too long for 80 columns.</p></li></ol><hr><h2 id="technical-details" tabindex="-1">Technical Details <a class="header-anchor" href="#technical-details" aria-label="Permalink to &quot;Technical Details&quot;">​</a></h2><h3 id="dependencies" tabindex="-1">Dependencies <a class="header-anchor" href="#dependencies" aria-label="Permalink to &quot;Dependencies&quot;">​</a></h3><div class="language-toml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">toml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">alacritty_terminal = </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;0.25&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # VT100/ANSI terminal emulation</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">portable-pty = </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;0.9&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         # Cross-platform PTY management</span></span></code></pre></div><h3 id="alacritty-terminal-capabilities-used" tabindex="-1">alacritty_terminal Capabilities Used <a class="header-anchor" href="#alacritty-terminal-capabilities-used" aria-label="Permalink to &quot;alacritty_terminal Capabilities Used&quot;">​</a></h3><ul><li><code>Term::grid()</code> - access to scrollback via negative line indices</li><li><code>grid.history_size()</code> - track scrollback growth</li><li><code>grid[Line(-n)]</code> - read scrollback lines</li><li><code>Term::selection</code> - native selection support</li><li><code>Term::selection_to_string()</code> - copy selected text</li><li><code>Term::scroll_display()</code> - scroll through history</li></ul><h3 id="scrollback-access" tabindex="-1">Scrollback Access <a class="header-anchor" href="#scrollback-access" aria-label="Permalink to &quot;Scrollback Access&quot;">​</a></h3><div class="language-rust vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> grid </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> term</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">grid</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> history_size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> grid</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">history_size</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Scrollback lines: Line(-history_size) to Line(-1)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Visible screen: Line(0) to Line(rows-1)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">..=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">history_size)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rev</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> line </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Line</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> i32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> row_data </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">grid[line];</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ... write line to backing file</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><hr><h2 id="references" tabindex="-1">References <a class="header-anchor" href="#references" aria-label="Permalink to &quot;References&quot;">​</a></h2><ul><li><a href="https://docs.rs/alacritty_terminal/latest/alacritty_terminal/" target="_blank" rel="noreferrer">alacritty_terminal docs</a></li><li><a href="https://docs.rs/portable-pty/latest/portable_pty/" target="_blank" rel="noreferrer">portable-pty docs</a></li><li><a href="https://deepwiki.com/zed-industries/zed/3.3-terminal" target="_blank" rel="noreferrer">Zed Terminal Architecture</a></li></ul>`,87)])])}const g=i(l,[["render",t]]);export{c as __pageData,g as default};
